# ðŸ—ï¸ Persistence System Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ProjectManager Component (UI)                   â”‚  â”‚
â”‚  â”‚  â€¢ Save Tab   â€¢ Load Tab   â€¢ Recovery Tab   â€¢ Settings Tab   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CORE PERSISTENCE API                           â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ProjectFileManager (Main Interface)            â”‚  â”‚
â”‚  â”‚  â€¢ saveProject()      â€¢ loadProject()                       â”‚  â”‚
â”‚  â”‚  â€¢ exportProject()    â€¢ getStatistics()                     â”‚  â”‚
â”‚  â”‚  â€¢ createProject()    â€¢ getCurrentProject()                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                     â”‚                             â”‚
â”‚                â–¼                     â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ProjectSerializer    â”‚  â”‚    AssetManager          â”‚          â”‚
â”‚  â”‚  â€¢ serializeLayer()   â”‚  â”‚    â€¢ addAsset()          â”‚          â”‚
â”‚  â”‚  â€¢ deserializeLayer() â”‚  â”‚    â€¢ getAsset()          â”‚          â”‚
â”‚  â”‚  â€¢ canvasToAsset()    â”‚  â”‚    â€¢ cleanupUnused()     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              AutoSaveManager (Background)                   â”‚  â”‚
â”‚  â”‚  â€¢ Auto-save every N seconds                                â”‚  â”‚
â”‚  â”‚  â€¢ Change detection                                         â”‚  â”‚
â”‚  â”‚  â€¢ Recovery point management                                â”‚  â”‚
â”‚  â”‚  â€¢ Crash detection                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       STORAGE LAYER                                 â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  File Storage   â”‚  â”‚  localStorage   â”‚  â”‚   IndexedDB     â”‚    â”‚
â”‚  â”‚  â€¢ .closset     â”‚  â”‚  â€¢ Recovery     â”‚  â”‚  â€¢ Large Data   â”‚    â”‚
â”‚  â”‚  â€¢ PNG/JPG      â”‚  â”‚  â€¢ Settings     â”‚  â”‚  â€¢ Assets       â”‚    â”‚
â”‚  â”‚  â€¢ JSON export  â”‚  â”‚  â€¢ Manifests    â”‚  â”‚  â€¢ Cache        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Saving

```
User Action (Save)
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProjectFileManager        â”‚
â”‚ .saveProject()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                              â”‚
           â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProjectSerializer      â”‚    â”‚ AssetManager        â”‚
â”‚ â€¢ Get all layers       â”‚    â”‚ â€¢ Extract canvases  â”‚
â”‚ â€¢ Serialize each       â”‚    â”‚ â€¢ Convert to PNG    â”‚
â”‚ â€¢ Convert canvases     â”‚    â”‚ â€¢ Store as assets   â”‚
â”‚ â€¢ Build SerializedLayerâ”‚    â”‚ â€¢ Generate checksumsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Build ProjectFile    â”‚
         â”‚ â€¢ metadata           â”‚
         â”‚ â€¢ layers[]           â”‚
         â”‚ â€¢ assets{}           â”‚
         â”‚ â€¢ appState           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Serialize to JSON    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Compress (optional)  â”‚
         â”‚ LZ-String            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Save to Storage      â”‚
         â”‚ â€¢ File (.closset)    â”‚
         â”‚ â€¢ localStorage       â”‚
         â”‚ â€¢ IndexedDB          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Loading

```
User Action (Load File)
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Read File                 â”‚
â”‚ â€¢ Parse JSON              â”‚
â”‚ â€¢ Decompress if needed    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProjectFileManager        â”‚
â”‚ .loadProjectFromFile()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                              â”‚
           â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AssetManager           â”‚    â”‚ ProjectSerializer   â”‚
â”‚ â€¢ Load asset registry  â”‚    â”‚ â€¢ Deserialize layersâ”‚
â”‚ â€¢ Store asset data     â”‚    â”‚ â€¢ Convert assets    â”‚
â”‚ â€¢ Build asset map      â”‚    â”‚   back to canvases  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Restore to Store     â”‚
         â”‚ â€¢ Update layers[]    â”‚
         â”‚ â€¢ Update groups[]    â”‚
         â”‚ â€¢ Update layerOrder  â”‚
         â”‚ â€¢ Restore appState   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Trigger Recompose    â”‚
         â”‚ â€¢ Render all layers  â”‚
         â”‚ â€¢ Update canvas      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Layer Serialization Detail

```
AdvancedLayer (Runtime Object)
â”œâ”€ id: string
â”œâ”€ name: string
â”œâ”€ type: LayerType
â”œâ”€ visible: boolean
â”œâ”€ opacity: number
â”œâ”€ content
â”‚  â”œâ”€ canvas: HTMLCanvasElement â”€â”€â”€â”€â”
â”‚  â”œâ”€ mask: HTMLCanvasElement â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€> Canvas â†’ PNG Blob
â”‚  â”œâ”€ clipMask.canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â†“
â”‚  â”œâ”€ displacementCanvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Base64 Encode
â”‚  â””â”€ imageElements[].src â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â†“
â”‚                                          AssetManager.addAsset()
â””â”€ effects[], transform, etc.              â†“
                                           assetId: "asset_abc123"
                â”‚
                â–¼
SerializedLayer (Storage Object)
â”œâ”€ id: string
â”œâ”€ name: string
â”œâ”€ type: LayerType
â”œâ”€ visible: boolean
â”œâ”€ opacity: number
â”œâ”€ content
â”‚  â”œâ”€ canvasAssetId: "asset_abc123" â”€â”€> Reference to asset
â”‚  â”œâ”€ mask.canvasAssetId: "asset_def456"
â”‚  â”œâ”€ clipMask.canvasAssetId: "asset_ghi789"
â”‚  â””â”€ imageElements[].assetId: "asset_jkl012"
â””â”€ effects[], transform, etc.
```

## Asset Storage Strategy

```
Asset Size Decision Tree:

Asset (Canvas/Image)
    â”‚
    â”œâ”€ Size < 100KB ?
    â”‚   â”œâ”€ YES â†’ Inline Storage
    â”‚   â”‚         â€¢ Convert to Base64
    â”‚   â”‚         â€¢ Include in JSON
    â”‚   â”‚         â€¢ storage.type = "inline"
    â”‚   â”‚
    â”‚   â””â”€ NO â†’ File Storage
    â”‚             â€¢ Save as separate file
    â”‚             â€¢ Reference in JSON
    â”‚             â€¢ storage.type = "file"
    â”‚             â€¢ storage.path = "assets/asset_xxx.png"
```

## Auto-Save Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         User Makes Changes                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Change Detection (Zustand Subscribe)   â”‚
â”‚      â†’ Mark hasUnsavedChanges = true        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Auto-Save Timer (Every N seconds)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Check Conditions:                      â”‚
â”‚      â€¢ hasUnsavedChanges?                   â”‚
â”‚      â€¢ !saveInProgress?                     â”‚
â”‚      â€¢ Enough time since last save?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ YES
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Perform Save                           â”‚
â”‚      â€¢ Save to storage                      â”‚
â”‚      â€¢ Create recovery point                â”‚
â”‚      â€¢ Clean up old backups                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Update State                           â”‚
â”‚      â€¢ lastSaveTime = now                   â”‚
â”‚      â€¢ hasUnsavedChanges = false            â”‚
â”‚      â€¢ saveInProgress = false               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Recovery System

```
App Startup
    â”‚
    â–¼
Check localStorage
for "closset_session_active"
    â”‚
    â”œâ”€ "true" ? â†’ CRASH DETECTED!
    â”‚              â”‚
    â”‚              â–¼
    â”‚         Get Recovery Points
    â”‚              â”‚
    â”‚              â”œâ”€ Sort by timestamp
    â”‚              â”œâ”€ Show to user
    â”‚              â””â”€ User selects one
    â”‚                     â”‚
    â”‚                     â–¼
    â”‚              Load from recovery point
    â”‚              Restore project state
    â”‚
    â””â”€ "false" ? â†’ Normal startup
                    Set "closset_session_active" = "true"

On Clean Exit:
    Set "closset_session_active" = "false"
```

## File Format Structure

```json
{
  "fileVersion": "1.0.0",
  "fileType": "closset-project",
  "createdAt": "2025-12-02T...",
  "modifiedAt": "2025-12-02T...",
  
  "project": {
    "id": "project_abc123",
    "name": "My Design",
    "canvas": { "width": 2048, "height": 2048, ... },
    "stats": { "layerCount": 12, "assetCount": 25, ... }
  },
  
  "layers": [
    {
      "id": "layer_1",
      "name": "Background",
      "type": "paint",
      "content": {
        "canvasAssetId": "asset_bg_123"
      },
      "effects": [...],
      "transform": {...}
    }
  ],
  
  "groups": [...],
  "layerOrder": ["layer_1", "layer_2", ...],
  
  "assets": {
    "version": "1.0.0",
    "assets": {
      "asset_bg_123": {
        "id": "asset_bg_123",
        "type": "canvas",
        "storage": {
          "type": "inline",
          "data": "data:image/png;base64,..."
        },
        "metadata": {...}
      }
    }
  },
  
  "appState": {
    "selectedLayerIds": [...],
    "view": {...},
    "ui": {...}
  }
}
```

## Module Dependencies

```
ProjectFileManager
â”œâ”€â”€ ProjectSerializer
â”‚   â”œâ”€â”€ AssetManager
â”‚   â””â”€â”€ AdvancedLayerSystemV2 (types)
â”œâ”€â”€ AssetManager
â””â”€â”€ LZ-String (compression)

AutoSaveManager
â”œâ”€â”€ ProjectFileManager
â””â”€â”€ AdvancedLayerSystemV2 (store)

ProjectManager (UI)
â”œâ”€â”€ ProjectFileManager
â””â”€â”€ AutoSaveManager
```

## Performance Optimization Points

```
1. Serialization
   â””â”€ Parallel processing of layers
      â€¢ Use Promise.all() for independent layers
      â€¢ Process each layer's canvas concurrently

2. Asset Management
   â””â”€ Lazy loading
      â€¢ Load assets only when needed
      â€¢ Cache loaded assets in memory

3. Compression
   â””â”€ Optional
      â€¢ Enable for large projects
      â€¢ Disable for quick saves

4. Auto-Save
   â””â”€ Debouncing
      â€¢ Only save when changes detected
      â€¢ Minimum interval between saves

5. Memory Management
   â””â”€ Cleanup
      â€¢ Release canvas references after save
      â€¢ Clear blob URLs after use
      â€¢ Garbage collection hints
```

## Error Handling Strategy

```
Each operation wrapped in try-catch:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Operation      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    try  â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Attempt Save   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Success â†’ Return true
         â”‚
         â””â”€ Error
               â”‚
          catch â”‚
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Log Error      â”‚
      â”‚  Show Message   â”‚
      â”‚  Attempt Retry  â”‚
      â”‚  Or Graceful    â”‚
      â”‚  Degradation    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Management Integration

```
Zustand Store (useAdvancedLayerStoreV2)
         â”‚
         â”‚ Current State
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layers              â”‚
â”‚  Groups              â”‚      Read
â”‚  LayerOrder          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Selected            â”‚          â”‚
â”‚  Active              â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
           â”‚                      â”‚
           â”‚ Changes         ProjectFileManager
           â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  Auto-Save           â”‚          â”‚
â”‚  Change Detection    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     Writeâ”‚
           â”‚                      â”‚
           â”‚ Save                 â”‚
           â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  ProjectFileManager  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Serialization       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Storage
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Files / Browser     â”‚
â”‚  Storage             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Legend:**
- `â”‚` `â”œ` `â””` `â”€` `â–¼` = Flow direction
- `â—„â”€â”€â”€â”€` = Data read
- `â”€â”€â”€â”€â–º` = Data write
- `â”Œâ”€â”` `â”‚ â”‚` `â””â”€â”˜` = Containers/modules

**Version:** 1.0.0  
**Created:** 2025-12-02


